{% extends 'base.html' %}
{% load static %}

{% block title %}
	<h1>Routes<h1>
{% endblock %}

{% block extrastylesheet %}
 <link rel="stylesheet" href="{% static 'css/leaflet_routing_machine.css' %}"/>
 <style>
  div.loader {
    width: 100px;
    height: 100px;
    position: fixed;
    top:0;
    bottom: 0;
    left: 0;
    right: 0;
    margin: auto;
 }
 </style>
{% endblock %}

{% block content %}
  <div>
	  <a href="{% url 'add_route' %}" class="vtms_buttons">Add Route</a>
	  <a href="{% url 'upload_routes_and_bin_data' %}" class="vtms_buttons">Upload Routes</a>
  </div>
  {% if routes %}
  <table class="table tablesorter">
    <thead class="thead-inverse">
      <tr>
        <th>Route</th>
        <th>Code</th>
        <th>Area</th>
	    <th>Bins</th>
        <th>Ward</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for route in routes %}
        <tr>
          <td>{{ route.name }}</td>
          <td>{{ route.code }}</td>
	  <td class="route_path" id="route_path_{{ route.id }}"><img src="{% static 'img/location.png' %}"></td>
	  <td id="bins_{{ route.id }}">
		<div id="add_view_reorder_bins_route_{{ route.id }}" class="view_bins">
			<a class="bins_from_{{route.id}}_{{route.ward.id}}">View bins</a>
		</div>
		<div style="display:none;" class="bin_info">
			<img src="{% static 'img/close.png' %}" class="close_bins">
			<div class="bins">
				<table class="table table-striped table-hover bins_belong_to_route" id="bins_from_{{route.id}}_{{route.ward.id}}">
					<thead class="thead-dark">
						<th style="text-align:center">Index</th>
						<th style="text-align:center">Bin</th>
						<th style="text-align:center">Action</th>
					</thead>
					<tbody class="bins_info">
						{% for bn in route.bins.all %}
							<tr id={{ bn.id }}>
								<td>{{ forloop.counter }}</td>
								<td style="text-align:center">{{ bn.name }}</td>
								<td><input type="button" value="Deallocate" id="{{ bn.id }}" class="deallocate_bins float-right"></td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
				<div class="add_bins">
					<div class="add_bins_link" style="text-align:right;">	
						<a href="#" class="add_bin_to_route_{{ route.id }}_{{ route.ward.id }}">Add Bins</a>
					</div>
					<div class="add_bins_form" id="allocate_bin_to_route_{{ route.id }}" style="display:none;">
						<select id="bins_route_{{ route.id }}_{{ route.ward.id }}" multiple style="width:100%"></select> 
						<input type="button" value="ADD" class="bins_route_{{ route.id }}_{{ route.ward.id }}"> 
						<input type="button" value="CANCEL" class="add_bins_cancel"> 
					</div>
				</div>
			</div>
		</div>
	  </td>
          <td>{{ route.ward }}</td>
	  <td>
		  <a id="{{route.id}}" href="#" class="vtms_buttons delete_route">Delete</a>
	  </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  	<h1>No Routes Found</h1>
  {% endif %}
  <div id="loadpositionmap" style="display: none;" align="center">
  </div>
  <div id="spinner" style="display: none;" class="loader">
        <img src="{% static 'img/loader.gif' %}" class="img-responsive">
  </div>
{% endblock %}

{% block js %}
<script src="{% static 'js/MovingMarker.js' %}"></script>
<script>
	let mymap = L.map('loadpositionmap').setView([19.122777, 72.894568],16);
	L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
	subdomain :['a','b','c']	
	}).addTo(mymap);

	var bin_icon = L.icon({
	    iconUrl: '{% static 'img/Bin.jpeg' %}',
	    iconSize: [24, 30],
	});

	$(document).ready(function(){
        $('table').tablesorter({theme:'metro-dark'});
		$("div.view_bins").click(function(){
			$("div.bin_info").each(function(i,elem){
				if($(elem).is(":visible")){
					$(elem).hide();
					$(elem).prev().show();
				}
			})

			$(this).hide();
			$(this).next().show();
		})
		$("img.close_bins").click(function(){
			$(this).parent().fadeOut();
			$(this).parent().prev().fadeIn();
		})

		$("div.add_bins_link").click(function(){
			$(this).next().show();
			$(this).hide();
		})

		$("input[class^='bins_route_']").click(function(){
			$(this).parent().prev().show();
			$(this).parent().hide();
		})


		$("input.add_bins_cancel").click(function(){
			$(this).parent().prev().show();
			$(this).parent().hide();
		})
	});


	var marker;
	var route_path;
	var added_markers = new Array();

	$("td.route_path").click(function () {
        $('#spinner').show();
		var route_name = new Array();
		var bins_from_route = new Array();
		route_name = $(this).attr('id').split("_");
		var rt_id = $(this).prev().text();
		if( marker ){
			mymap.removeLayer(marker);
		}

		if(added_markers.length){
			$.each(added_markers, function(i, each_added_bin) {
				mymap.removeLayer(each_added_bin);
			});	
		}

		if( route_path ){
			route_path.remove();
		}

		$.ajax({
			type:'GET',						
			url:'{% url "get_bin_location_from_route" %}',
			data: {
				'id':rt_id 
			},
			beforeSend: function(xhr) {
				xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}" );
			},
			success:function(res){
				 var resp = res.data;
				 $.each(resp, function(i, bin) {
					let Bin= JSON.parse(bin.location);
					bin = L.geoJSON(Bin,{
						pointToLayer : function(geoJsonPoint, latlng){
							bins_from_route.push(latlng);
							return L.marker(latlng,{icon : bin_icon }).bindPopup('<b>' + bin.code.split('_').pop() + '  ' + bin.name + '</b>' );
						}
					}).addTo(mymap);
					 
					added_markers.push(bin);
				 });

				 route_path = L.Routing.control({
				 waypoints: bins_from_route,
                                 show: false,
                                 waypointMode: 'snap',
                                 router: L.Routing.mapbox('pk.eyJ1IjoiZGhpcmFqc2hpbmRlMTIxMDgzIiwiYSI6ImNrYTlpMjdqaTBuM3Ayc21rNnN1bzl5Y2EifQ.EGvhAM99uPWkNzB314HXHg'),
				 createMarker : function(){ return null;}	 
                                 }).addTo(mymap);

				 $("#loadpositionmap").dialog({
					 modal: true,
					 autoOpen: false,
					 width: 1000,
					 height: 1000
				 });

				 $("#loadpositionmap").dialog('open');
                 $('#spinner').hide();

			     mymap.invalidateSize();
			},
			error:function(a,b,c){
				alert(b);
				alert(c);					
			}						
		});
	});


	$("a[class^='add_bin_to_route_']").click(function(event) {
		event.preventDefault();
		$div = $(this).parent().next();
		$current_div = $(this).parent();
		var info = $(this).attr('class').split("_");
		var ward_id  = info[5];
		var route_id = info[4];
		var ward_route = route_id + '_' + ward_id;

		$('select#bins_route_'+ ward_route).empty();

		if (!$('#bins_route_'+ ward_route).has('option').length) {
			$.ajax({
				type:'GET',						
				url:'{% url "get_unallocated_bins_from_ward" %}',
				data: {
					'id':ward_id 
				},
				beforeSend: function(xhr) {
					xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}" );
				},
				success:function(res){
					var resp = res.data;
					if (! resp.length){
						$div.hide();
						$current_div.show();
						alert('No Unallocated bins in ward');
						return false;
					}
					else{
						 console.log(resp);
						 $.each(resp, function(i, bin) {
							 $('#bins_route_'+ ward_route).append($('<option></option>').val(bin.id).html(bin.name));
							 $current_div.hide();
							 $div.show();
						 })
					}	
				},
				error:function(a,b,c){
					alert(b);
					alert(c);					
				}						

			});
		}
		else{
			return false;
		}
	});

	$("input[class^='reorder_bins_from_']").click(function(event) {
		event.preventDefault();
		var info = $(this).attr('class').split("_");
		var route_id = info[3];
		var ward_id  = info[4];
		var ward_route = route_id + '_' + ward_id;
		var reordered_bins = [];

		if ($("table#bins_from_"+ ward_route + " tbody").children().length !== '0') {
			var updateInfo ={};
			$("table#bins_from_"+ ward_route + " tbody tr").each(function(index,elem){
				var bn_id = $(this).attr('id'); 
				reordered_bins.push(bn_id)
			})

			$.ajax({
				type:'GET',						
				url:'{% url "reorder_bins" %}',
				data: {
					'bins[]':reordered_bins 
				},
				beforeSend: function(xhr) {
					xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}" );
				},
				success:function(res){
					/*
					 $.each(resp, function(i, bin) {
						 $('#add_bins_from_route_'+ ward_route).append($('<option></option>').val(bin.pk).html(bin.fields.name));
					 })
					*/
				},
				error:function(a,b,c){
					alert(b);
					alert(c);					
				}						

			});
		}
		else{
			return false;
		}
	});

	$("input[class^='bins_route_']").click(function(event) {
		var select_id = $(this).attr('class').split(" ");
		var bin_info = select_id[0].split("_");
		var ward_id  = bin_info[3];
		var route_id = bin_info[2];
		selected_bins = "bins_route_" + route_id + '_' + ward_id;
		var bins = $("#"+ select_id ).val().join(",");
		var bin_data = {
				bins:bins, 
				ward:ward_id,
				route:route_id
			       };

		$.ajax({
			type:'GET',						
			url:'{% url "allocate_bins_to_route" %}',
			data: bin_data,
			beforeSend: function(xhr) {
				xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}" );
			},
			success:function(res){
				var resp = res.data;
				location.reload();
			},
			error:function(a,b,c){
				alert(b);
				alert(c);					
			}						
		});
	});

	$("input[class='cancel']").click(function(event) {
		$(this).parent().hide();
	});

	$("input[class^='deallocate_bins']").click(function(event) {
		var bin = $(this).attr('id');
		var tr  = $(this).closest('tr');

        if (tr.siblings().length < 2 ){
            alert("Bins deallocation is not possible for 2 bins route")
            return false;
        }

		$.ajax({
			type:'GET',						
			url:'{% url "deallocate_bin_from_route" %}',
			data: {
				'id':bin 
			},
			beforeSend: function(xhr) {
				xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}" );
			},
			success:function(res){
				 var resp = res.data;
				 tr.find('td').fadeOut(1000,function(){
					if( tr.is(":not(:last-child)") ){
						tr.nextAll().each(function(index,each_tr){
							console.log(each_tr);
						});
					}
					tr.remove();
				 });
			},
			error:function(a,b,c){
				alert(b);
				alert(c);					
			}						

		});
	})

	$("div.add_view_bins").click(function(e){
		e.preventDefault();
		if( $(this).next().is(":visible") ){
			$(this).next().hide();
			$(this).find('a:first').text('View bins');
		}
		else{
			$("div.bins").each(function(i,elem){
				if($(elem).is(":visible")){
					$(elem).hide();
					//alert($(elem).find('a:first').text());
					//$(elem).find('a:first').text('View bins');
					//alert($(elem).find('a:first').text());
				}
			});
			$(this).next().show();
			$(this).find('a:first').text('Hide bins');
		}
	})

	$("a.delete_route").click(function () {
		var route_id = $(this).attr('id');
		var $tr = $(this).closest('tr');

		$.ajax({
			type:'POST',
			url:'{% url "delete_route" %}',
			data: {
				'id':route_id 
			},
			beforeSend: function(xhr) {
				xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}" );
			},
			success:function(res){
				$tr.find('td').fadeOut(1000,function(){
					$tr.remove();
				})
			},
			error:function(a,b,c){
				alert(b);
				alert(c);
			}
		});
	});
</script>
{% endblock %}
